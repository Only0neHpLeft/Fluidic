# Fluidic v0.0.2 Gamification Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add full gamification with 26 unique color-coded badges, XP/leveling, streak freeze, and daily challenges — all in EN + CS.

**Architecture:** Extend existing SwiftData models (Achievement, UserSettings) and AchievementManager. Add new DailyChallenge model and XPManager/ChallengeManager services. Badge visuals are SwiftUI-drawn circles with unique colors. All new strings localized.

**Tech Stack:** SwiftUI, SwiftData, SF Symbols

---

### Task 1: Add colorHex and textOverlay to Achievement model

**Files:**
- Modify: `Fluidic/Models/Achievement.swift`

**Step 1: Add new stored properties**

Add after `category` (line 12):
```swift
var colorHex: String
var textOverlay: String?
```

**Step 2: Update initializer**

Add parameters and assignments:
```swift
init(achievementId: String, title: String, descriptionText: String, iconName: String, category: String, colorHex: String = "#78909C", textOverlay: String? = nil, unlockedAt: Date? = nil) {
    self.achievementId = achievementId
    self.title = title
    self.descriptionText = descriptionText
    self.iconName = iconName
    self.category = category
    self.colorHex = colorHex
    self.textOverlay = textOverlay
    self.unlockedAt = unlockedAt
}
```

**Step 3: Add a Color computed property**

Add a helper that converts hex to Color:
```swift
var color: Color {
    let hex = colorHex.trimmingCharacters(in: CharacterSet(charactersIn: "#"))
    guard let int = UInt64(hex, radix: 16) else { return .gray }
    let r = Double((int >> 16) & 0xFF) / 255.0
    let g = Double((int >> 8) & 0xFF) / 255.0
    let b = Double(int & 0xFF) / 255.0
    return Color(red: r, green: g, blue: b)
}
```

Add `import SwiftUI` at the top of the file.

**Step 4: Commit**
```bash
git add Fluidic/Models/Achievement.swift
git commit -m "feat: add colorHex and textOverlay to Achievement model"
```

---

### Task 2: Add XP, streak freeze, and challenge fields to UserSettings

**Files:**
- Modify: `Fluidic/Models/UserSettings.swift`

**Step 1: Add new properties after `hasCompletedOnboarding` (line 14)**

```swift
var totalXP: Int
var currentLevel: Int
var streakFreezeCount: Int
var frozenDatesData: Data?
var challengesCompleted: Int
var lastStreakFreezeAwardedAt: Int // streak length when last freeze was awarded
```

**Step 2: Add to initializer parameters (with defaults)**

```swift
totalXP: Int = 0,
currentLevel: Int = 1,
streakFreezeCount: Int = 0,
frozenDatesData: Data? = nil,
challengesCompleted: Int = 0,
lastStreakFreezeAwardedAt: Int = 0
```

**Step 3: Add assignments in init body**

```swift
self.totalXP = totalXP
self.currentLevel = currentLevel
self.streakFreezeCount = streakFreezeCount
self.frozenDatesData = frozenDatesData
self.challengesCompleted = challengesCompleted
self.lastStreakFreezeAwardedAt = lastStreakFreezeAwardedAt
```

**Step 4: Add frozenDates computed helper**

```swift
var frozenDates: [Date] {
    get {
        guard let data = frozenDatesData else { return [] }
        return (try? JSONDecoder().decode([Date].self, from: data)) ?? []
    }
    set {
        frozenDatesData = try? JSONEncoder().encode(newValue)
    }
}
```

**Step 5: Commit**
```bash
git add Fluidic/Models/UserSettings.swift
git commit -m "feat: add XP, streak freeze, and challenge fields to UserSettings"
```

---

### Task 3: Create DailyChallenge SwiftData model

**Files:**
- Create: `Fluidic/Models/DailyChallenge.swift`
- Modify: `Fluidic/FluidicApp.swift` (add to modelContainer)

**Step 1: Create DailyChallenge model**

Create `Fluidic/Models/DailyChallenge.swift`:
```swift
import Foundation
import SwiftData

@Model
final class DailyChallenge {
    var date: Date
    var challengeIndex: Int
    var completed: Bool
    var completedAt: Date?

    init(date: Date, challengeIndex: Int, completed: Bool = false, completedAt: Date? = nil) {
        self.date = date
        self.challengeIndex = challengeIndex
        self.completed = completed
        self.completedAt = completedAt
    }
}
```

**Step 2: Add to modelContainer in FluidicApp.swift**

Update the modelContainer line:
```swift
.modelContainer(for: [WaterIntake.self, UserSettings.self, Achievement.self, DailyChallenge.self])
```

**Step 3: Commit**
```bash
git add Fluidic/Models/DailyChallenge.swift Fluidic/FluidicApp.swift
git commit -m "feat: add DailyChallenge SwiftData model"
```

---

### Task 4: Create XPManager service

**Files:**
- Create: `Fluidic/Services/XPManager.swift`

**Step 1: Create XPManager**

Create `Fluidic/Services/XPManager.swift`:
```swift
import Foundation

struct XPLevel {
    let level: Int
    let xpRequired: Int
    let titleEN: String
    let titleCS: String
}

@Observable
final class XPManager {

    var showLevelUp = false
    var newLevel: Int = 0

    static let levels: [XPLevel] = [
        XPLevel(level: 1, xpRequired: 0, titleEN: "Beginner", titleCS: "Začátečník"),
        XPLevel(level: 2, xpRequired: 300, titleEN: "Hydration Rookie", titleCS: "Nováček hydratace"),
        XPLevel(level: 3, xpRequired: 800, titleEN: "Water Apprentice", titleCS: "Vodní učeň"),
        XPLevel(level: 4, xpRequired: 1500, titleEN: "Hydration Pro", titleCS: "Profík hydratace"),
        XPLevel(level: 5, xpRequired: 3000, titleEN: "Water Master", titleCS: "Vodní mistr"),
        XPLevel(level: 6, xpRequired: 5000, titleEN: "Hydration Legend", titleCS: "Legenda hydratace"),
        XPLevel(level: 7, xpRequired: 8000, titleEN: "Aqua Champion", titleCS: "Aqua šampion"),
        XPLevel(level: 8, xpRequired: 12000, titleEN: "Supreme Hydrator", titleCS: "Nejvyšší hydrátor"),
        XPLevel(level: 9, xpRequired: 18000, titleEN: "Fluidic Elite", titleCS: "Fluidic elita"),
        XPLevel(level: 10, xpRequired: 25000, titleEN: "Transcendent", titleCS: "Transcendentní"),
    ]

    /// Add XP and check for level up
    func awardXP(_ amount: Int, settings: UserSettings?) {
        guard let settings else { return }
        settings.totalXP += amount

        let newLvl = Self.levelFor(xp: settings.totalXP)
        if newLvl > settings.currentLevel {
            settings.currentLevel = newLvl
            newLevel = newLvl
            showLevelUp = true
        }
    }

    /// Calculate level for given XP
    static func levelFor(xp: Int) -> Int {
        var level = 1
        for l in levels {
            if xp >= l.xpRequired { level = l.level }
            else { break }
        }
        return level
    }

    /// XP needed for next level
    static func xpForNextLevel(currentLevel: Int) -> Int {
        if currentLevel >= levels.count { return levels.last?.xpRequired ?? 0 }
        return levels[currentLevel].xpRequired
    }

    /// XP threshold for current level
    static func xpForCurrentLevel(currentLevel: Int) -> Int {
        guard currentLevel >= 1, currentLevel <= levels.count else { return 0 }
        return levels[currentLevel - 1].xpRequired
    }

    /// Progress fraction to next level (0.0 - 1.0)
    static func progressToNextLevel(totalXP: Int, currentLevel: Int) -> Double {
        if currentLevel >= levels.count { return 1.0 }
        let currentThreshold = xpForCurrentLevel(currentLevel: currentLevel)
        let nextThreshold = xpForNextLevel(currentLevel: currentLevel)
        let range = nextThreshold - currentThreshold
        guard range > 0 else { return 1.0 }
        return Double(totalXP - currentThreshold) / Double(range)
    }

    /// Title for a level
    static func title(for level: Int, isCS: Bool) -> String {
        guard level >= 1, level <= levels.count else { return "" }
        let l = levels[level - 1]
        return isCS ? l.titleCS : l.titleEN
    }

    func dismissLevelUp() {
        showLevelUp = false
    }
}
```

**Step 2: Commit**
```bash
git add Fluidic/Services/XPManager.swift
git commit -m "feat: add XPManager service with 10 levels"
```

---

### Task 5: Create ChallengeManager service

**Files:**
- Create: `Fluidic/Services/ChallengeManager.swift`

**Step 1: Create ChallengeManager**

Create `Fluidic/Services/ChallengeManager.swift`:
```swift
import Foundation
import SwiftData

struct ChallengeDefinition {
    let textEN: String
    let textCS: String
    let check: (ChallengeContext) -> Bool
}

struct ChallengeContext {
    let todayTotal: Double
    let dailyGoal: Double
    let todayEntries: [WaterIntake]
    let yesterdayTotal: Double
    let activeHoursStart: Int
}

@Observable
final class ChallengeManager {

    private var modelContext: ModelContext?
    var todayChallenge: DailyChallenge?

    static let challenges: [ChallengeDefinition] = [
        // 0: Log before 9 AM
        ChallengeDefinition(textEN: "Log before 9 AM", textCS: "Zaznamenejte před 9:00") { ctx in
            ctx.todayEntries.contains { Calendar.current.component(.hour, from: $0.timestamp) < 9 }
        },
        // 1: Drink 3000 ml today
        ChallengeDefinition(textEN: "Drink 3000 ml today", textCS: "Vypijte dnes 3000 ml") { ctx in
            ctx.todayTotal >= 3000
        },
        // 2: Log 6 separate entries
        ChallengeDefinition(textEN: "Log 6 separate entries", textCS: "Zaznamenejte 6 záznamů") { ctx in
            ctx.todayEntries.count >= 6
        },
        // 3: Reach goal by 3 PM
        ChallengeDefinition(textEN: "Reach goal by 3 PM", textCS: "Splňte cíl do 15:00") { ctx in
            let hour = Calendar.current.component(.hour, from: Date())
            return ctx.todayTotal >= ctx.dailyGoal && hour < 15
        },
        // 4: Log at least 500 ml at once
        ChallengeDefinition(textEN: "Log at least 500 ml at once", textCS: "Zaznamenejte 500 ml najednou") { ctx in
            ctx.todayEntries.contains { $0.amount >= 500 }
        },
        // 5: Drink every 2 hours
        ChallengeDefinition(textEN: "Drink every 2 hours", textCS: "Pijte každé 2 hodiny") { ctx in
            let windows = Set(ctx.todayEntries.map { Calendar.current.component(.hour, from: $0.timestamp) / 2 })
            return windows.count >= 4
        },
        // 6: Start with 250 ml
        ChallengeDefinition(textEN: "Start with 250 ml", textCS: "Začněte s 250 ml") { ctx in
            guard let first = ctx.todayEntries.first else { return false }
            return first.amount >= 250
        },
        // 7: Reach 50% by noon
        ChallengeDefinition(textEN: "Reach 50% by noon", textCS: "Dosáhněte 50 % do poledne") { ctx in
            let noonEntries = ctx.todayEntries.filter { Calendar.current.component(.hour, from: $0.timestamp) < 12 }
            let noonTotal = noonEntries.reduce(0.0) { $0 + $1.amount }
            return noonTotal >= ctx.dailyGoal * 0.5
        },
        // 8: Log 8 times today
        ChallengeDefinition(textEN: "Log 8 times today", textCS: "Zaznamenejte 8 záznamů dnes") { ctx in
            ctx.todayEntries.count >= 8
        },
        // 9: Beat yesterday's total
        ChallengeDefinition(textEN: "Beat yesterday's total", textCS: "Překonejte včerejšek") { ctx in
            ctx.todayTotal > ctx.yesterdayTotal
        },
        // 10: Drink 2000 ml by 2 PM
        ChallengeDefinition(textEN: "Drink 2000 ml by 2 PM", textCS: "Vypijte 2000 ml do 14:00") { ctx in
            let entries = ctx.todayEntries.filter { Calendar.current.component(.hour, from: $0.timestamp) < 14 }
            return entries.reduce(0.0) { $0 + $1.amount } >= 2000
        },
        // 11: Log after 8 PM
        ChallengeDefinition(textEN: "Log after 8 PM", textCS: "Zaznamenejte po 20:00") { ctx in
            ctx.todayEntries.contains { Calendar.current.component(.hour, from: $0.timestamp) >= 20 }
        },
        // 12: Reach 120% of goal
        ChallengeDefinition(textEN: "Reach 120% of goal", textCS: "Dosáhněte 120 % cíle") { ctx in
            ctx.todayTotal >= ctx.dailyGoal * 1.2
        },
        // 13: No gaps > 3 hours
        ChallengeDefinition(textEN: "No gaps longer than 3 hours", textCS: "Bez mezer delších než 3 hodiny") { ctx in
            let sorted = ctx.todayEntries.sorted { $0.timestamp < $1.timestamp }
            guard sorted.count >= 2 else { return false }
            for i in 1..<sorted.count {
                if sorted[i].timestamp.timeIntervalSince(sorted[i-1].timestamp) > 3 * 3600 { return false }
            }
            return true
        },
        // 14: First entry within 30 min
        ChallengeDefinition(textEN: "First entry within 30 min of waking", textCS: "První záznam do 30 min") { ctx in
            guard let first = ctx.todayEntries.first else { return false }
            let hour = Calendar.current.component(.hour, from: first.timestamp)
            let minute = Calendar.current.component(.minute, from: first.timestamp)
            let entryMinutes = hour * 60 + minute
            let wakeMinutes = ctx.activeHoursStart * 60
            return entryMinutes <= wakeMinutes + 30
        },
    ]

    func configure(modelContext: ModelContext) {
        self.modelContext = modelContext
        loadOrCreateTodayChallenge()
    }

    private func loadOrCreateTodayChallenge() {
        guard let modelContext else { return }
        let startOfDay = Calendar.current.startOfDay(for: .now)
        let endOfDay = Calendar.current.date(byAdding: .day, value: 1, to: startOfDay)!

        let descriptor = FetchDescriptor<DailyChallenge>(
            predicate: #Predicate<DailyChallenge> { $0.date >= startOfDay && $0.date < endOfDay }
        )
        if let existing = (try? modelContext.fetch(descriptor))?.first {
            todayChallenge = existing
        } else {
            // Deterministic challenge selection based on date
            let daysSinceEpoch = Int(startOfDay.timeIntervalSince1970 / 86400)
            let index = abs(daysSinceEpoch) % Self.challenges.count
            let challenge = DailyChallenge(date: startOfDay, challengeIndex: index)
            modelContext.insert(challenge)
            try? modelContext.save()
            todayChallenge = challenge
        }
    }

    /// Check if today's challenge is completed
    func checkChallenge(context: ChallengeContext) -> Bool {
        guard let challenge = todayChallenge, !challenge.completed else { return false }
        let index = challenge.challengeIndex
        guard index >= 0, index < Self.challenges.count else { return false }

        if Self.challenges[index].check(context) {
            challenge.completed = true
            challenge.completedAt = Date()
            try? modelContext?.save()
            return true
        }
        return false
    }

    /// Get current challenge text
    func challengeText(isCS: Bool) -> String {
        guard let challenge = todayChallenge else { return "" }
        let index = challenge.challengeIndex
        guard index >= 0, index < Self.challenges.count else { return "" }
        return isCS ? Self.challenges[index].textCS : Self.challenges[index].textEN
    }
}
```

**Step 2: Commit**
```bash
git add Fluidic/Services/ChallengeManager.swift
git commit -m "feat: add ChallengeManager service with 15 daily challenges"
```

---

### Task 6: Expand AchievementManager to 26 badges with colors

**Files:**
- Modify: `Fluidic/Services/AchievementManager.swift` (replace definitions, update seeding, update checking)

**Step 1: Update AchievementDefinition struct**

Add `colorHex` and `textOverlay` to the struct:
```swift
struct AchievementDefinition {
    let id: String
    let titleEN: String
    let titleCS: String
    let descEN: String
    let descCS: String
    let icon: String
    let category: String
    let colorHex: String
    let textOverlay: String?
}
```

**Step 2: Replace the definitions array**

Replace `static let definitions` with all 26 badges from the design doc. Each entry includes `colorHex` and `textOverlay` (nil for SF Symbol badges, string for text badges).

The full 26-badge definitions array (too long to inline here — use the badge table from the design doc `docs/plans/2026-02-23-v0.0.2-gamification-design.md`):

```swift
static let definitions: [AchievementDefinition] = [
    AchievementDefinition(id: "first_sip", titleEN: "First Sip", titleCS: "První doušek", descEN: "Log your first water intake", descCS: "Zaznamenejte svůj první příjem vody", icon: "drop.fill", category: "hydration", colorHex: "#4FC3F7", textOverlay: nil),
    AchievementDefinition(id: "goal_reached", titleEN: "Daily Champion", titleCS: "Denní šampion", descEN: "Reach your daily goal for the first time", descCS: "Poprvé dosáhněte denního cíle", icon: "trophy.fill", category: "hydration", colorHex: "#FFD700", textOverlay: nil),
    AchievementDefinition(id: "streak_3", titleEN: "Consistent", titleCS: "Vytrvalý", descEN: "Maintain a 3-day streak", descCS: "Udržujte 3denní sérii", icon: "flame.fill", category: "streak", colorHex: "#FF7043", textOverlay: nil),
    AchievementDefinition(id: "streak_7", titleEN: "Week Warrior", titleCS: "Týdenní bojovník", descEN: "Maintain a 7-day streak", descCS: "Udržujte 7denní sérii", icon: "flame.fill", category: "streak", colorHex: "#FF5722", textOverlay: nil),
    AchievementDefinition(id: "streak_14", titleEN: "Two Weeks Strong", titleCS: "Dva týdny v řadě", descEN: "Maintain a 14-day streak", descCS: "Udržujte 14denní sérii", icon: "flame.fill", category: "streak", colorHex: "#F44336", textOverlay: nil),
    AchievementDefinition(id: "streak_30", titleEN: "Monthly Master", titleCS: "Měsíční mistr", descEN: "Maintain a 30-day streak", descCS: "Udržujte 30denní sérii", icon: "star.fill", category: "streak", colorHex: "#E91E63", textOverlay: nil),
    AchievementDefinition(id: "streak_60", titleEN: "Unstoppable", titleCS: "Nezastavitelný", descEN: "Maintain a 60-day streak", descCS: "Udržujte 60denní sérii", icon: "bolt.circle.fill", category: "streak", colorHex: "#D32F2F", textOverlay: nil),
    AchievementDefinition(id: "early_bird", titleEN: "Early Bird", titleCS: "Ranní ptáče", descEN: "Log water before 8 AM", descCS: "Zaznamenejte vodu před 8:00", icon: "sunrise.fill", category: "milestone", colorHex: "#FFA726", textOverlay: nil),
    AchievementDefinition(id: "night_owl", titleEN: "Night Owl", titleCS: "Noční sova", descEN: "Log water after 10 PM", descCS: "Zaznamenejte vodu po 22:00", icon: "moon.fill", category: "milestone", colorHex: "#5C6BC0", textOverlay: nil),
    AchievementDefinition(id: "midnight_sip", titleEN: "Midnight Sip", titleCS: "Půlnoční doušek", descEN: "Log water between midnight and 4 AM", descCS: "Zaznamenejte vodu mezi půlnocí a 4:00", icon: "moon.stars.fill", category: "milestone", colorHex: "#283593", textOverlay: nil),
    AchievementDefinition(id: "big_gulp", titleEN: "Big Gulp", titleCS: "Velký doušek", descEN: "Log 500 ml or more in one entry", descCS: "Zaznamenejte 500 ml nebo více najednou", icon: "drop.triangle.fill", category: "hydration", colorHex: "#26C6DA", textOverlay: nil),
    AchievementDefinition(id: "hydration_1L", titleEN: "Liter Legend", titleCS: "Litrová legenda", descEN: "Log 1000 ml in one day", descCS: "Zaznamenejte 1000 ml za den", icon: "drop.fill", category: "hydration", colorHex: "#29B6F6", textOverlay: "1L"),
    AchievementDefinition(id: "hydration_5L", titleEN: "Ocean Mode", titleCS: "Oceánový mód", descEN: "Log 5000 ml in one day", descCS: "Zaznamenejte 5000 ml za den", icon: "water.waves", category: "hydration", colorHex: "#0277BD", textOverlay: nil),
    AchievementDefinition(id: "overachiever", titleEN: "Overachiever", titleCS: "Přeborník", descEN: "Reach 150% of your daily goal", descCS: "Dosáhněte 150 % denního cíle", icon: "bolt.fill", category: "hydration", colorHex: "#AB47BC", textOverlay: nil),
    AchievementDefinition(id: "double_goal", titleEN: "Double Down", titleCS: "Dvojnásobek", descEN: "Reach 200% of your daily goal", descCS: "Dosáhněte 200 % denního cíle", icon: "bolt.fill", category: "hydration", colorHex: "#7E57C2", textOverlay: "2x"),
    AchievementDefinition(id: "centurion", titleEN: "Centurion", titleCS: "Centurion", descEN: "Log 100 total water entries", descCS: "Zaznamenejte celkem 100 příjmů vody", icon: "circle.fill", category: "milestone", colorHex: "#EC407A", textOverlay: "100"),
    AchievementDefinition(id: "entries_10", titleEN: "Getting Started", titleCS: "Začátečník", descEN: "Log 10 total entries", descCS: "Zaznamenejte celkem 10 příjmů", icon: "circle.fill", category: "milestone", colorHex: "#78909C", textOverlay: "10"),
    AchievementDefinition(id: "entries_500", titleEN: "Half Thousand", titleCS: "Půl tisíce", descEN: "Log 500 total entries", descCS: "Zaznamenejte celkem 500 příjmů", icon: "circle.fill", category: "milestone", colorHex: "#8D6E63", textOverlay: "500"),
    AchievementDefinition(id: "entries_1000", titleEN: "Thousandaire", titleCS: "Tisícovka", descEN: "Log 1000 total entries", descCS: "Zaznamenejte celkem 1000 příjmů", icon: "circle.fill", category: "milestone", colorHex: "#FF8F00", textOverlay: "1K"),
    AchievementDefinition(id: "early_streak_3", titleEN: "Morning Ritual", titleCS: "Ranní rituál", descEN: "Log before 8 AM three days in a row", descCS: "Zaznamenejte před 8:00 tři dny v řadě", icon: "sun.max.fill", category: "milestone", colorHex: "#FFB74D", textOverlay: nil),
    AchievementDefinition(id: "weekend_warrior", titleEN: "Weekend Warrior", titleCS: "Víkendový bojovník", descEN: "Meet goal on both Saturday and Sunday", descCS: "Splňte cíl v sobotu i v neděli", icon: "calendar", category: "milestone", colorHex: "#66BB6A", textOverlay: nil),
    AchievementDefinition(id: "perfect_week", titleEN: "Perfect Week", titleCS: "Perfektní týden", descEN: "Meet goal all 7 days of the week", descCS: "Splňte cíl všech 7 dní v týdnu", icon: "checkmark.seal.fill", category: "milestone", colorHex: "#43A047", textOverlay: nil),
    AchievementDefinition(id: "challenge_5", titleEN: "Challenger", titleCS: "Vyzyvatel", descEN: "Complete 5 daily challenges", descCS: "Splňte 5 denních výzev", icon: "flag.fill", category: "challenge", colorHex: "#00897B", textOverlay: nil),
    AchievementDefinition(id: "challenge_20", titleEN: "Challenge Master", titleCS: "Mistr výzev", descEN: "Complete 20 daily challenges", descCS: "Splňte 20 denních výzev", icon: "flag.checkered", category: "challenge", colorHex: "#00695C", textOverlay: nil),
    AchievementDefinition(id: "xp_1000", titleEN: "XP Hunter", titleCS: "Lovec XP", descEN: "Earn 1000 total XP", descCS: "Získejte celkem 1000 XP", icon: "sparkles", category: "xp", colorHex: "#FFC107", textOverlay: nil),
    AchievementDefinition(id: "early_tester", titleEN: "Early Tester", titleCS: "Raný tester", descEN: "Using Fluidic before v1.0", descCS: "Používání Fluidic před v1.0", icon: "hammer.fill", category: "special", colorHex: "#9C27B0", textOverlay: nil),
]
```

**Step 3: Update seedAchievementsIfNeeded**

Change the seeding logic to handle upgrades (add new badges that don't exist yet, don't recreate existing):
```swift
private func seedAchievementsIfNeeded() {
    guard let modelContext else { return }
    let descriptor = FetchDescriptor<Achievement>()
    let existing = (try? modelContext.fetch(descriptor)) ?? []
    let existingIds = Set(existing.map(\.achievementId))

    for def in Self.definitions {
        if existingIds.contains(def.id) {
            // Update colorHex and textOverlay on existing badges
            if let badge = existing.first(where: { $0.achievementId == def.id }) {
                badge.colorHex = def.colorHex
                badge.textOverlay = def.textOverlay
            }
        } else {
            let achievement = Achievement(
                achievementId: def.id,
                title: def.titleEN,
                descriptionText: def.descEN,
                iconName: def.icon,
                category: def.category,
                colorHex: def.colorHex,
                textOverlay: def.textOverlay
            )
            modelContext.insert(achievement)
        }
    }
    try? modelContext.save()
}
```

**Step 4: Update checkAchievements signature**

Add new parameters needed for the new badges:
```swift
func checkAchievements(
    todayTotal: Double,
    dailyGoal: Double,
    lastIntakeAmount: Double,
    streak: Int,
    totalEntries: Int,
    intakeHour: Int,
    locale: Locale,
    todayEntries: [WaterIntake],
    challengesCompleted: Int,
    totalXP: Int,
    appVersion: String
)
```

**Step 5: Expand the switch statement**

Add cases for all 16 new badge IDs in the switch:
```swift
case "streak_14": shouldUnlock = streak >= 14
case "streak_60": shouldUnlock = streak >= 60
case "midnight_sip": shouldUnlock = intakeHour >= 0 && intakeHour < 4
case "hydration_1L": shouldUnlock = todayTotal >= 1000
case "hydration_5L": shouldUnlock = todayTotal >= 5000
case "double_goal": shouldUnlock = todayTotal >= dailyGoal * 2.0
case "entries_10": shouldUnlock = totalEntries >= 10
case "entries_500": shouldUnlock = totalEntries >= 500
case "entries_1000": shouldUnlock = totalEntries >= 1000
case "early_streak_3": shouldUnlock = checkEarlyStreak3()
case "weekend_warrior": shouldUnlock = checkWeekendWarrior()
case "perfect_week": shouldUnlock = checkPerfectWeek()
case "challenge_5": shouldUnlock = challengesCompleted >= 5
case "challenge_20": shouldUnlock = challengesCompleted >= 20
case "xp_1000": shouldUnlock = totalXP >= 1000
case "early_tester": shouldUnlock = appVersion.hasPrefix("0.")
```

**Step 6: Add helper methods for complex badge checks**

Add these private methods to AchievementManager:
```swift
private func checkEarlyStreak3() -> Bool {
    guard let modelContext else { return false }
    let calendar = Calendar.current
    for dayOffset in 0..<3 {
        guard let date = calendar.date(byAdding: .day, value: -dayOffset, to: calendar.startOfDay(for: .now)) else { return false }
        let end = calendar.date(byAdding: .day, value: 1, to: date)!
        let eightAM = calendar.date(bySettingHour: 8, minute: 0, second: 0, of: date)!
        let descriptor = FetchDescriptor<WaterIntake>(predicate: #Predicate<WaterIntake> { $0.timestamp >= date && $0.timestamp < eightAM })
        let count = (try? modelContext.fetchCount(descriptor)) ?? 0
        if count == 0 { return false }
    }
    return true
}

private func checkWeekendWarrior() -> Bool {
    guard let modelContext else { return false }
    let calendar = Calendar.current
    let today = calendar.startOfDay(for: .now)
    let weekday = calendar.component(.weekday, from: today)
    // Find most recent Saturday (weekday 7) and Sunday (weekday 1)
    let daysToSaturday = (weekday + 6) % 7  // days since last Saturday
    let daysToSunday = (weekday + 5) % 7    // days since last Sunday (if 0, it's today)
    guard let saturday = calendar.date(byAdding: .day, value: -daysToSaturday, to: today),
          let sunday = calendar.date(byAdding: .day, value: -daysToSunday, to: today) else { return false }
    return totalForDate(saturday) >= (settings?.dailyGoalML ?? 2500) &&
           totalForDate(sunday) >= (settings?.dailyGoalML ?? 2500)
}

private func checkPerfectWeek() -> Bool {
    let calendar = Calendar.current
    let today = calendar.startOfDay(for: .now)
    let goal = settings?.dailyGoalML ?? 2500
    for dayOffset in 0..<7 {
        guard let date = calendar.date(byAdding: .day, value: -dayOffset, to: today) else { return false }
        if totalForDate(date) < goal { return false }
    }
    return true
}

private func totalForDate(_ date: Date) -> Double {
    guard let modelContext else { return 0 }
    let calendar = Calendar.current
    let start = calendar.startOfDay(for: date)
    let end = calendar.date(byAdding: .day, value: 1, to: start)!
    let descriptor = FetchDescriptor<WaterIntake>(predicate: #Predicate<WaterIntake> { $0.timestamp >= start && $0.timestamp < end })
    let entries = (try? modelContext.fetch(descriptor)) ?? []
    return entries.reduce(0) { $0 + $1.amount }
}
```

Also add a `settings` property:
```swift
private var settings: UserSettings?

func configure(modelContext: ModelContext) {
    self.modelContext = modelContext
    loadSettings()
    seedAchievementsIfNeeded()
}

private func loadSettings() {
    guard let modelContext else { return }
    let descriptor = FetchDescriptor<UserSettings>()
    settings = (try? modelContext.fetch(descriptor))?.first
}
```

**Step 7: Commit**
```bash
git add Fluidic/Services/AchievementManager.swift
git commit -m "feat: expand AchievementManager to 26 color-coded badges"
```

---

### Task 7: Update AchievementBadgeView for custom colors

**Files:**
- Modify: `Fluidic/Components/AchievementBadgeView.swift`

**Step 1: Replace the badge visual**

Replace the body to use `achievement.color` for unlocked badges and show `textOverlay` when present:
```swift
var body: some View {
    Button {
        if achievement.isUnlocked {
            showDetail = true
        }
    } label: {
        VStack(spacing: 6) {
            ZStack {
                Circle()
                    .fill(achievement.isUnlocked ? achievement.color : Color.gray.opacity(0.2))
                    .frame(width: 56, height: 56)

                if achievement.isUnlocked {
                    if let text = achievement.textOverlay {
                        Text(text)
                            .font(.system(size: 18, weight: .bold, design: .rounded))
                            .foregroundStyle(.white)
                    } else {
                        Image(systemName: achievement.iconName)
                            .font(.title2)
                            .foregroundStyle(.white)
                    }
                } else {
                    Image(systemName: "lock.fill")
                        .font(.caption)
                        .foregroundStyle(FluidicTheme.textSecondary.opacity(0.5))
                }
            }

            Text(achievement.isUnlocked ? achievement.title : "???")
                .font(.caption2)
                .foregroundStyle(achievement.isUnlocked ? FluidicTheme.textPrimary : FluidicTheme.textSecondary)
                .lineLimit(1)
        }
        .frame(maxWidth: .infinity)
    }
    .buttonStyle(.plain)
    .accessibilityLabel(achievement.isUnlocked ? achievement.title : String(localized: "Locked achievement"))
    .accessibilityHint(achievement.isUnlocked ? achievement.descriptionText : String(localized: "Keep tracking to unlock"))
    .alert(achievement.title, isPresented: $showDetail) {
        Button(String(localized: "OK"), role: .cancel) {}
    } message: {
        if let date = achievement.unlockedAt {
            Text("\(achievement.descriptionText)\n\n\(String(localized: "Unlocked:"))\n\(date.formatted(date: .abbreviated, time: .omitted))")
        }
    }
}
```

**Step 2: Commit**
```bash
git add Fluidic/Components/AchievementBadgeView.swift
git commit -m "feat: update badge visuals with per-badge colors and text overlays"
```

---

### Task 8: Create XPBarView component and integrate into HomeView

**Files:**
- Create: `Fluidic/Components/XPBarView.swift`
- Modify: `Fluidic/Views/HomeView.swift`

**Step 1: Create XPBarView**

Create `Fluidic/Components/XPBarView.swift`:
```swift
import SwiftUI

struct XPBarView: View {
    let totalXP: Int
    let currentLevel: Int
    let isCS: Bool

    private var progress: Double {
        XPManager.progressToNextLevel(totalXP: totalXP, currentLevel: currentLevel)
    }

    private var levelTitle: String {
        XPManager.title(for: currentLevel, isCS: isCS)
    }

    var body: some View {
        VStack(spacing: 6) {
            HStack {
                Text(String(localized: "Level \(currentLevel)"))
                    .font(.system(size: 13, weight: .bold, design: .rounded))
                    .foregroundStyle(FluidicTheme.textPrimary)

                Text("• \(levelTitle)")
                    .font(.system(size: 13, weight: .medium, design: .rounded))
                    .foregroundStyle(FluidicTheme.textSecondary)

                Spacer()

                Text("\(totalXP) XP")
                    .font(.system(size: 12, weight: .semibold, design: .rounded))
                    .foregroundStyle(FluidicTheme.waterBlue)
            }

            GeometryReader { geometry in
                ZStack(alignment: .leading) {
                    RoundedRectangle(cornerRadius: 4)
                        .fill(FluidicTheme.lightBlue.opacity(0.3))

                    RoundedRectangle(cornerRadius: 4)
                        .fill(FluidicTheme.waterBlue)
                        .frame(width: geometry.size.width * progress)
                        .animation(.spring(response: 0.5), value: progress)
                }
            }
            .frame(height: 8)
        }
        .padding(.horizontal)
    }
}
```

**Step 2: Add XPBarView to HomeView**

In `Fluidic/Views/HomeView.swift`, read the file and add the XPBarView after the progress text section (after the "Tap the cup..." text) and before the quick-add buttons:
```swift
// XP progress
XPBarView(
    totalXP: viewModel.settings?.totalXP ?? 0,
    currentLevel: viewModel.settings?.currentLevel ?? 1,
    isCS: viewModel.appLocale.language.languageCode?.identifier == "cs"
)
```

**Step 3: Commit**
```bash
git add Fluidic/Components/XPBarView.swift Fluidic/Views/HomeView.swift
git commit -m "feat: add XP progress bar to HomeView"
```

---

### Task 9: Create DailyChallengeCard component and integrate into HomeView

**Files:**
- Create: `Fluidic/Components/DailyChallengeCard.swift`
- Modify: `Fluidic/Views/HomeView.swift`

**Step 1: Create DailyChallengeCard**

Create `Fluidic/Components/DailyChallengeCard.swift`:
```swift
import SwiftUI

struct DailyChallengeCard: View {
    let challengeText: String
    let isCompleted: Bool

    var body: some View {
        HStack(spacing: 12) {
            Image(systemName: isCompleted ? "checkmark.circle.fill" : "flag.fill")
                .font(.title3)
                .foregroundStyle(isCompleted ? FluidicTheme.successGreen : FluidicTheme.waterBlue)

            VStack(alignment: .leading, spacing: 2) {
                Text(String(localized: "Daily Challenge"))
                    .font(.system(size: 12, weight: .semibold, design: .rounded))
                    .foregroundStyle(FluidicTheme.textSecondary)

                Text(challengeText)
                    .font(.system(size: 15, weight: .medium, design: .rounded))
                    .foregroundStyle(FluidicTheme.textPrimary)
            }

            Spacer()

            if isCompleted {
                Text("+75 XP")
                    .font(.system(size: 12, weight: .bold, design: .rounded))
                    .foregroundStyle(FluidicTheme.successGreen)
            }
        }
        .padding()
        .background(
            RoundedRectangle(cornerRadius: 16)
                .fill(FluidicTheme.cardBackground)
                .shadow(color: FluidicTheme.cardShadow, radius: 8, y: 4)
        )
        .padding(.horizontal)
    }
}
```

**Step 2: Add DailyChallengeCard to HomeView**

In `Fluidic/Views/HomeView.swift`, after the quick-add buttons section, add:
```swift
// Daily challenge
if let challenge = viewModel.challengeManager.todayChallenge {
    DailyChallengeCard(
        challengeText: viewModel.challengeManager.challengeText(
            isCS: viewModel.appLocale.language.languageCode?.identifier == "cs"
        ),
        isCompleted: challenge.completed
    )
}
```

**Step 3: Commit**
```bash
git add Fluidic/Components/DailyChallengeCard.swift Fluidic/Views/HomeView.swift
git commit -m "feat: add daily challenge card to HomeView"
```

---

### Task 10: Integrate XPManager, ChallengeManager, and streak freeze into WaterViewModel

**Files:**
- Modify: `Fluidic/ViewModels/WaterViewModel.swift`
- Modify: `Fluidic/ContentView.swift`

**Step 1: Add new managers to WaterViewModel**

Add after `achievementManager`:
```swift
var xpManager = XPManager()
var challengeManager = ChallengeManager()
```

**Step 2: Update addWater() to award XP, check challenges, and update achievements call**

After the existing achievement check in `addWater()`, add:
```swift
// Award XP for logging
xpManager.awardXP(10, settings: settings)

// Check if goal just reached for XP
if todayTotal >= dailyGoal && (todayTotal - ml) < dailyGoal {
    xpManager.awardXP(50, settings: settings)
}

// Check daily challenge
let ctx = ChallengeContext(
    todayTotal: todayTotal,
    dailyGoal: dailyGoal,
    todayEntries: todayIntakes,
    yesterdayTotal: totalForDate(Calendar.current.date(byAdding: .day, value: -1, to: Calendar.current.startOfDay(for: .now))!),
    activeHoursStart: settings?.activeHoursStart ?? 8
)
if challengeManager.checkChallenge(context: ctx) {
    xpManager.awardXP(75, settings: settings)
    settings?.challengesCompleted = (settings?.challengesCompleted ?? 0) + 1
}

// Check streak freeze award (every 7 days)
let currentStreakVal = currentStreak()
if currentStreakVal > 0, currentStreakVal % 7 == 0,
   currentStreakVal > (settings?.lastStreakFreezeAwardedAt ?? 0),
   (settings?.streakFreezeCount ?? 0) < 3 {
    settings?.streakFreezeCount = (settings?.streakFreezeCount ?? 0) + 1
    settings?.lastStreakFreezeAwardedAt = currentStreakVal
}

saveChanges()
```

**Step 3: Update the checkAchievements call to pass new parameters**

Update the existing call to include new parameters:
```swift
let appVersion = Bundle.main.infoDictionary?["CFBundleShortVersionString"] as? String ?? "0.0.1"
achievementManager.checkAchievements(
    todayTotal: todayTotal,
    dailyGoal: dailyGoal,
    lastIntakeAmount: intake.amount,
    streak: currentStreak(),
    totalEntries: totalEntries,
    intakeHour: hour,
    locale: appLocale,
    todayEntries: todayIntakes,
    challengesCompleted: settings?.challengesCompleted ?? 0,
    totalXP: settings?.totalXP ?? 0,
    appVersion: appVersion
)

// Award XP for badge unlocks
if achievementManager.newlyUnlocked != nil {
    xpManager.awardXP(100, settings: settings)
}
```

**Step 4: Update currentStreak() to use streak freeze**

Modify the `currentStreak()` method to check for frozen dates when a day has 0 intake:
```swift
func currentStreak() -> Int {
    let calendar = Calendar.current
    var streak = 0
    var checkDate = calendar.startOfDay(for: .now)
    let frozenDates = settings?.frozenDates ?? []

    if todayTotal < dailyGoal {
        guard let yesterday = calendar.date(byAdding: .day, value: -1, to: checkDate) else { return 0 }
        checkDate = yesterday
    }

    while true {
        let total = totalForDate(checkDate)
        if total >= dailyGoal {
            streak += 1
        } else if frozenDates.contains(where: { calendar.isDate($0, inSameDayAs: checkDate) }) {
            streak += 1 // frozen day counts
        } else if total == 0, let freezeCount = settings?.streakFreezeCount, freezeCount > 0 {
            // Auto-use a freeze
            settings?.streakFreezeCount = freezeCount - 1
            var dates = settings?.frozenDates ?? []
            dates.append(checkDate)
            settings?.frozenDates = dates
            saveChanges()
            streak += 1
        } else {
            break
        }
        guard let prevDay = calendar.date(byAdding: .day, value: -1, to: checkDate) else { break }
        checkDate = prevDay
    }

    return streak
}
```

**Step 5: Configure new managers in ContentView**

In `Fluidic/ContentView.swift`, inside the `.onAppear` block after `vm.achievementManager.configure(...)`:
```swift
vm.challengeManager.configure(modelContext: modelContext)
```

**Step 6: Add level-up overlay to HomeView**

In `Fluidic/Views/HomeView.swift`, add after the achievement toast overlay:
```swift
// Level up celebration
if viewModel.xpManager.showLevelUp {
    LevelUpView(level: viewModel.xpManager.newLevel, isCS: viewModel.appLocale.language.languageCode?.identifier == "cs") {
        viewModel.xpManager.dismissLevelUp()
    }
}
```

**Step 7: Create LevelUpView**

Create `Fluidic/Components/LevelUpView.swift`:
```swift
import SwiftUI

struct LevelUpView: View {
    let level: Int
    let isCS: Bool
    let onDismiss: () -> Void
    @State private var opacity = 0.0

    var body: some View {
        ZStack {
            Color.black.opacity(0.3)
                .ignoresSafeArea()
                .onTapGesture { onDismiss() }

            VStack(spacing: 16) {
                Text(String(localized: "Level Up!"))
                    .font(.system(size: 28, weight: .bold, design: .rounded))
                    .foregroundStyle(FluidicTheme.textPrimary)

                Text(String(localized: "Level \(level)"))
                    .font(.system(size: 48, weight: .bold, design: .rounded))
                    .foregroundStyle(FluidicTheme.waterBlue)

                Text(XPManager.title(for: level, isCS: isCS))
                    .font(.system(size: 18, weight: .medium, design: .rounded))
                    .foregroundStyle(FluidicTheme.textSecondary)

                Button(String(localized: "Continue")) {
                    onDismiss()
                }
                .font(.system(size: 16, weight: .semibold, design: .rounded))
                .foregroundStyle(.white)
                .padding(.horizontal, 32)
                .padding(.vertical, 12)
                .background(RoundedRectangle(cornerRadius: 12).fill(FluidicTheme.accent))
                .padding(.top, 8)
            }
            .padding(32)
            .background(
                RoundedRectangle(cornerRadius: 32)
                    .fill(FluidicTheme.cardBackground)
                    .shadow(color: FluidicTheme.cardShadow, radius: 32, y: 16)
            )
            .padding(40)
        }
        .opacity(opacity)
        .onAppear {
            withAnimation(.easeIn(duration: 0.3)) { opacity = 1 }
        }
    }
}
```

**Step 8: Commit**
```bash
git add Fluidic/ViewModels/WaterViewModel.swift Fluidic/ContentView.swift Fluidic/Views/HomeView.swift Fluidic/Components/LevelUpView.swift
git commit -m "feat: integrate XP, challenges, and streak freeze into water logging flow"
```

---

### Task 11: Update streak card in HistoryView with freeze display

**Files:**
- Modify: `Fluidic/Views/HistoryView.swift`

**Step 1: Update streak card**

Read HistoryView.swift. In the streak card section, add freeze count display after "Keep it going!":
```swift
if (viewModel.settings?.streakFreezeCount ?? 0) > 0 {
    HStack(spacing: 4) {
        Image(systemName: "snowflake")
            .font(.system(size: 12))
            .foregroundStyle(.cyan)
        Text(String(localized: "\(viewModel.settings?.streakFreezeCount ?? 0) freezes"))
            .font(.system(size: 12, weight: .medium, design: .rounded))
            .foregroundStyle(FluidicTheme.textSecondary)
    }
}
```

**Step 2: Update calendar to show frozen days**

In MonthCalendarView, update `dotColor` to handle frozen dates:
```swift
private func dotColor(total: Double, isFuture: Bool, date: Date) -> Color {
    if isFuture { return FluidicTheme.lightBlue.opacity(0.2) }
    let frozen = viewModel.settings?.frozenDates ?? []
    if frozen.contains(where: { Calendar.current.isDate($0, inSameDayAs: date) }) {
        return .cyan.opacity(0.4)
    }
    if total >= viewModel.dailyGoal { return FluidicTheme.successGreen }
    if total > 0 { return FluidicTheme.secondaryBlue.opacity(0.5) }
    return FluidicTheme.lightBlue.opacity(0.3)
}
```

Update the calendar dot `ForEach` to pass the date to `dotColor`.

**Step 3: Commit**
```bash
git add Fluidic/Views/HistoryView.swift
git commit -m "feat: show streak freeze count and frozen days in HistoryView"
```

---

### Task 12: Add localization strings for v0.0.2 features (EN + CS)

**Files:**
- Modify: `Fluidic/Localizable.xcstrings`

**Step 1: Add all new keys**

Add entries for: "Level Up!", "Level %lld", "Daily Challenge", "+75 XP", "%lld XP", "%lld freezes", "Streak Saved!", and all challenge texts. Follow the existing JSON format with `cs` translations.

**Step 2: Commit**
```bash
git add Fluidic/Localizable.xcstrings
git commit -m "feat: add EN + CS localization for XP, challenges, and streak freeze"
```

---

### Task 13: Update version to 0.0.2 and final build verification

**Files:**
- Modify: `Fluidic.xcodeproj/project.pbxproj`

**Step 1: Update all MARKETING_VERSION to 0.0.2**

**Step 2: Full clean build**
```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 17 Pro' clean build 2>&1 | tail -20
```

**Step 3: Fix any build errors**

**Step 4: Commit**
```bash
git add -A
git commit -m "chore: bump version to 0.0.2 and final build verification"
```

---

## Summary

| Task | Description | Files |
|------|-------------|-------|
| 1 | Add colorHex/textOverlay to Achievement | Achievement.swift |
| 2 | Add XP, freeze, challenge fields to UserSettings | UserSettings.swift |
| 3 | Create DailyChallenge model | DailyChallenge.swift, FluidicApp.swift |
| 4 | Create XPManager service | XPManager.swift |
| 5 | Create ChallengeManager service | ChallengeManager.swift |
| 6 | Expand AchievementManager to 26 badges | AchievementManager.swift |
| 7 | Update AchievementBadgeView for colors | AchievementBadgeView.swift |
| 8 | Create XPBarView + integrate HomeView | XPBarView.swift, HomeView.swift |
| 9 | Create DailyChallengeCard + integrate | DailyChallengeCard.swift, HomeView.swift |
| 10 | Integrate all managers into ViewModel | WaterViewModel.swift, ContentView.swift, HomeView.swift, LevelUpView.swift |
| 11 | Update HistoryView with freeze display | HistoryView.swift |
| 12 | Localization (EN + CS) | Localizable.xcstrings |
| 13 | Version bump + final build | project.pbxproj |
