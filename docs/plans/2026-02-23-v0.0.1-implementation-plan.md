# Fluidic v0.0.1 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Ship an App Store-ready v0.0.1 with achievements, onboarding, bug fixes, and accessibility — supporting English and Czech.

**Architecture:** SwiftUI + SwiftData MVVM. New Achievement model + AchievementManager service. OnboardingView as a conditional root overlay. All strings localized via Localizable.xcstrings.

**Tech Stack:** SwiftUI, SwiftData, UserNotifications, Swift Charts, SF Symbols

---

### Task 1: Fix version consistency and clean up HealthKit references

**Files:**
- Modify: `Fluidic.xcodeproj/project.pbxproj` (version fields)

**Step 1: Unify version numbers**

Open the Xcode project in Finder or use sed to ensure ALL targets have:
```
MARKETING_VERSION = 0.0.1
CURRENT_PROJECT_VERSION = 1
```

Search for any `MARKETING_VERSION = 1.0` entries and change them to `0.0.1`.

**Step 2: Verify no HealthKit references remain in Swift source**

Search all `.swift` files for `HealthKit`, `HKHealthStore`, `HealthKitManager`. There should be zero matches since the file was already deleted. If any remain, remove them.

**Step 3: Commit**

```bash
git add -A && git commit -m "fix: unify version to 0.0.1 and clean HealthKit references"
```

---

### Task 2: Fix notification reliability — reschedule on app foreground

**Files:**
- Modify: `Fluidic/ContentView.swift:25-29` (add scenePhase handling)
- Modify: `Fluidic/ViewModels/WaterViewModel.swift:154-183` (add public reschedule method)

**Step 1: Add scenePhase environment to ContentView**

In `Fluidic/ContentView.swift`, add after line 6 (`@State private var viewModel: WaterViewModel?`):
```swift
@Environment(\.scenePhase) private var scenePhase
```

**Step 2: Add onChange for scenePhase**

In `Fluidic/ContentView.swift`, add a `.onChange` modifier after the `.task` modifier (after line 29):
```swift
.onChange(of: scenePhase) { _, newPhase in
    if newPhase == .active, let viewModel {
        viewModel.loadTodayIntakes()
        Task {
            await viewModel.scheduleReminders()
        }
    }
}
```

**Step 3: Make scheduleReminders public**

In `Fluidic/ViewModels/WaterViewModel.swift`, the `scheduleReminders()` function at line 162 should already be accessible. Verify it's not marked `private`. If it is, remove the `private` keyword.

**Step 4: Build and verify**

```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
```

**Step 5: Commit**

```bash
git add Fluidic/ContentView.swift Fluidic/ViewModels/WaterViewModel.swift
git commit -m "fix: reschedule notifications on app foreground for reliability"
```

---

### Task 3: Fix saving reliability — explicit saves after mutations

**Files:**
- Modify: `Fluidic/ViewModels/WaterViewModel.swift:78-103` (addWater, resetToday)

**Step 1: Verify addWater has explicit save**

In `Fluidic/ViewModels/WaterViewModel.swift`, the `addWater()` function (line 78) should call `saveChanges()` after inserting. Read the function and verify `saveChanges()` is called. If not, add it after the insert.

**Step 2: Verify resetToday has explicit save**

The `resetToday()` function (line 96) deletes entries. Verify it calls `saveChanges()` after deletion. If not, add:
```swift
saveChanges()
```
after the for-loop that deletes entries.

**Step 3: Make saveChanges use try/catch**

Replace the `saveChanges()` function (line 185-187) with:
```swift
func saveChanges() {
    do {
        try modelContext?.save()
    } catch {
        print("Failed to save: \(error)")
    }
}
```

**Step 4: Build and verify**

```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
```

**Step 5: Commit**

```bash
git add Fluidic/ViewModels/WaterViewModel.swift
git commit -m "fix: explicit saves after all data mutations to prevent data loss"
```

---

### Task 4: Fix wave animation dampening near 100%

**Files:**
- Modify: `Fluidic/Components/WaterCupView.swift:14-17` (waveAmplitude computed property)

**Step 1: Smooth the dampening curve**

In `Fluidic/Components/WaterCupView.swift`, replace the `waveAmplitude` computed property (around lines 14-17) with a smoother easing:

```swift
private var waveAmplitude: CGFloat {
    let base: CGFloat = 4.0
    if progress < 0.05 { return base * (progress / 0.05) }
    if progress > 0.80 { return base * pow((1.0 - progress) / 0.20, 0.5) }
    return base
}
```

This uses a square root curve instead of linear for a gradual fade-out, and also adds fade-in at the bottom.

**Step 2: Build and verify**

```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
```

**Step 3: Commit**

```bash
git add Fluidic/Components/WaterCupView.swift
git commit -m "fix: smooth wave dampening curve near 0% and 100% fill"
```

---

### Task 5: Add Achievement SwiftData model

**Files:**
- Create: `Fluidic/Models/Achievement.swift`
- Modify: `Fluidic/FluidicApp.swift:10` (add Achievement to modelContainer)

**Step 1: Create Achievement model**

Create `Fluidic/Models/Achievement.swift`:
```swift
import Foundation
import SwiftData

@Model
final class Achievement {
    #Unique([\.achievementId])

    var achievementId: String
    var title: String
    var descriptionText: String
    var iconName: String
    var category: String
    var unlockedAt: Date?

    var isUnlocked: Bool { unlockedAt != nil }

    init(achievementId: String, title: String, descriptionText: String, iconName: String, category: String, unlockedAt: Date? = nil) {
        self.achievementId = achievementId
        self.title = title
        self.descriptionText = descriptionText
        self.iconName = iconName
        self.category = category
        self.unlockedAt = unlockedAt
    }
}
```

**Step 2: Add Achievement to modelContainer**

In `Fluidic/FluidicApp.swift`, update the modelContainer line (line 10) to include Achievement:
```swift
.modelContainer(for: [WaterIntake.self, UserSettings.self, Achievement.self])
```

**Step 3: Build and verify**

```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
```

**Step 4: Commit**

```bash
git add Fluidic/Models/Achievement.swift Fluidic/FluidicApp.swift
git commit -m "feat: add Achievement SwiftData model"
```

---

### Task 6: Create AchievementManager service

**Files:**
- Create: `Fluidic/Services/AchievementManager.swift`

**Step 1: Create AchievementManager**

Create `Fluidic/Services/AchievementManager.swift`:
```swift
import Foundation
import SwiftData

@Observable
final class AchievementManager {

    private var modelContext: ModelContext?

    /// The most recently unlocked achievement, for toast display
    var newlyUnlocked: Achievement?

    struct AchievementDefinition {
        let id: String
        let titleEN: String
        let titleCS: String
        let descEN: String
        let descCS: String
        let icon: String
        let category: String
    }

    static let definitions: [AchievementDefinition] = [
        AchievementDefinition(id: "first_sip", titleEN: "First Sip", titleCS: "První doušek", descEN: "Log your first water intake", descCS: "Zaznamenejte svůj první příjem vody", icon: "drop.fill", category: "hydration"),
        AchievementDefinition(id: "goal_reached", titleEN: "Daily Champion", titleCS: "Denní šampion", descEN: "Reach your daily goal for the first time", descCS: "Poprvé dosáhněte denního cíle", icon: "trophy.fill", category: "hydration"),
        AchievementDefinition(id: "streak_3", titleEN: "Consistent", titleCS: "Vytrvalý", descEN: "Maintain a 3-day streak", descCS: "Udržujte 3denní sérii", icon: "flame.fill", category: "streak"),
        AchievementDefinition(id: "streak_7", titleEN: "Week Warrior", titleCS: "Týdenní bojovník", descEN: "Maintain a 7-day streak", descCS: "Udržujte 7denní sérii", icon: "flame.fill", category: "streak"),
        AchievementDefinition(id: "streak_30", titleEN: "Monthly Master", titleCS: "Měsíční mistr", descEN: "Maintain a 30-day streak", descCS: "Udržujte 30denní sérii", icon: "star.fill", category: "streak"),
        AchievementDefinition(id: "early_bird", titleEN: "Early Bird", titleCS: "Ranní ptáče", descEN: "Log water before 8 AM", descCS: "Zaznamenejte vodu před 8:00", icon: "sunrise.fill", category: "milestone"),
        AchievementDefinition(id: "night_owl", titleEN: "Night Owl", titleCS: "Noční sova", descEN: "Log water after 10 PM", descCS: "Zaznamenejte vodu po 22:00", icon: "moon.fill", category: "milestone"),
        AchievementDefinition(id: "big_gulp", titleEN: "Big Gulp", titleCS: "Velký doušek", descEN: "Log 500 ml or more in one entry", descCS: "Zaznamenejte 500 ml nebo více najednou", icon: "drop.triangle.fill", category: "hydration"),
        AchievementDefinition(id: "overachiever", titleEN: "Overachiever", titleCS: "Přeborník", descEN: "Reach 150% of your daily goal", descCS: "Dosáhněte 150 % denního cíle", icon: "bolt.fill", category: "hydration"),
        AchievementDefinition(id: "centurion", titleEN: "Centurion", titleCS: "Centurion", descEN: "Log 100 total water entries", descCS: "Zaznamenejte celkem 100 příjmů vody", icon: "100.circle.fill", category: "milestone"),
    ]

    func configure(modelContext: ModelContext) {
        self.modelContext = modelContext
        seedAchievementsIfNeeded()
    }

    /// Create achievement records on first launch
    private func seedAchievementsIfNeeded() {
        guard let modelContext else { return }
        let descriptor = FetchDescriptor<Achievement>()
        let existing = (try? modelContext.fetch(descriptor)) ?? []
        guard existing.isEmpty else { return }

        for def in Self.definitions {
            let achievement = Achievement(
                achievementId: def.id,
                title: def.titleEN,
                descriptionText: def.descEN,
                iconName: def.icon,
                category: def.category
            )
            modelContext.insert(achievement)
        }
        try? modelContext.save()
    }

    /// Call after every addWater to check unlock conditions
    func checkAchievements(
        todayTotal: Double,
        dailyGoal: Double,
        lastIntakeAmount: Double,
        streak: Int,
        totalEntries: Int,
        intakeHour: Int,
        locale: Locale
    ) {
        guard let modelContext else { return }
        let descriptor = FetchDescriptor<Achievement>(predicate: #Predicate { $0.unlockedAt == nil })
        guard let locked = try? modelContext.fetch(descriptor) else { return }

        let isCS = locale.language.languageCode?.identifier == "cs"

        for achievement in locked {
            var shouldUnlock = false

            switch achievement.achievementId {
            case "first_sip":
                shouldUnlock = true // If we're checking, water was just logged
            case "goal_reached":
                shouldUnlock = todayTotal >= dailyGoal
            case "streak_3":
                shouldUnlock = streak >= 3
            case "streak_7":
                shouldUnlock = streak >= 7
            case "streak_30":
                shouldUnlock = streak >= 30
            case "early_bird":
                shouldUnlock = intakeHour < 8
            case "night_owl":
                shouldUnlock = intakeHour >= 22
            case "big_gulp":
                shouldUnlock = lastIntakeAmount >= 500
            case "overachiever":
                shouldUnlock = todayTotal >= dailyGoal * 1.5
            case "centurion":
                shouldUnlock = totalEntries >= 100
            default:
                break
            }

            if shouldUnlock {
                achievement.unlockedAt = Date()
                // Update title/description to match current locale
                if isCS, let def = Self.definitions.first(where: { $0.id == achievement.achievementId }) {
                    achievement.title = def.titleCS
                    achievement.descriptionText = def.descCS
                } else if let def = Self.definitions.first(where: { $0.id == achievement.achievementId }) {
                    achievement.title = def.titleEN
                    achievement.descriptionText = def.descEN
                }
                newlyUnlocked = achievement
            }
        }

        try? modelContext.save()
    }

    /// Fetch all achievements sorted by category
    func allAchievements() -> [Achievement] {
        guard let modelContext else { return [] }
        let descriptor = FetchDescriptor<Achievement>(sortBy: [SortDescriptor(\.category), SortDescriptor(\.achievementId)])
        return (try? modelContext.fetch(descriptor)) ?? []
    }

    /// Count of total entries (for centurion check)
    func totalEntryCount() -> Int {
        guard let modelContext else { return 0 }
        let descriptor = FetchDescriptor<WaterIntake>()
        return (try? modelContext.fetchCount(descriptor)) ?? 0
    }

    /// Dismiss the toast
    func dismissToast() {
        newlyUnlocked = nil
    }
}
```

**Step 2: Build and verify**

```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
```

**Step 3: Commit**

```bash
git add Fluidic/Services/AchievementManager.swift
git commit -m "feat: add AchievementManager service with 10 badge definitions"
```

---

### Task 7: Integrate AchievementManager into WaterViewModel

**Files:**
- Modify: `Fluidic/ViewModels/WaterViewModel.swift:7-12` (add achievementManager property)
- Modify: `Fluidic/ViewModels/WaterViewModel.swift:78-94` (call checkAchievements in addWater)
- Modify: `Fluidic/ContentView.swift:39-43` (configure achievementManager)

**Step 1: Add achievementManager to WaterViewModel**

In `Fluidic/ViewModels/WaterViewModel.swift`, add after the existing properties (around line 12):
```swift
var achievementManager = AchievementManager()
```

**Step 2: Call checkAchievements in addWater**

In `Fluidic/ViewModels/WaterViewModel.swift`, inside `addWater()` after the celebration check and before the notification reschedule, add:
```swift
let hour = Calendar.current.component(.hour, from: Date())
let totalEntries = achievementManager.totalEntryCount()
achievementManager.checkAchievements(
    todayTotal: todayTotal,
    dailyGoal: dailyGoal,
    lastIntakeAmount: intake.amount,
    streak: currentStreak(),
    totalEntries: totalEntries,
    intakeHour: hour,
    locale: appLocale
)
```

**Step 3: Configure achievementManager in ContentView**

In `Fluidic/ContentView.swift`, inside the `onAppear` closure where viewModel is created (around line 41), add after viewModel setup:
```swift
vm.achievementManager.configure(modelContext: context)
```

**Step 4: Build and verify**

```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
```

**Step 5: Commit**

```bash
git add Fluidic/ViewModels/WaterViewModel.swift Fluidic/ContentView.swift
git commit -m "feat: integrate achievement checking into water logging flow"
```

---

### Task 8: Create AchievementBadgeView component

**Files:**
- Create: `Fluidic/Components/AchievementBadgeView.swift`

**Step 1: Create the badge component**

Create `Fluidic/Components/AchievementBadgeView.swift`:
```swift
import SwiftUI

struct AchievementBadgeView: View {
    let achievement: Achievement
    @State private var showDetail = false

    var body: some View {
        Button {
            if achievement.isUnlocked {
                showDetail = true
            }
        } label: {
            VStack(spacing: 6) {
                ZStack {
                    Circle()
                        .fill(achievement.isUnlocked ? FluidicTheme.waterBlue.opacity(0.15) : Color.gray.opacity(0.1))
                        .frame(width: 56, height: 56)

                    if achievement.isUnlocked {
                        Image(systemName: achievement.iconName)
                            .font(.title2)
                            .foregroundStyle(FluidicTheme.waterBlue)
                    } else {
                        Image(systemName: "lock.fill")
                            .font(.caption)
                            .foregroundStyle(FluidicTheme.textSecondary.opacity(0.5))
                    }
                }

                Text(achievement.isUnlocked ? achievement.title : "???")
                    .font(.caption2)
                    .foregroundStyle(achievement.isUnlocked ? FluidicTheme.textPrimary : FluidicTheme.textSecondary)
                    .lineLimit(1)
            }
            .frame(maxWidth: .infinity)
        }
        .buttonStyle(.plain)
        .accessibilityLabel(achievement.isUnlocked ? achievement.title : String(localized: "Locked achievement"))
        .accessibilityHint(achievement.isUnlocked ? achievement.descriptionText : String(localized: "Keep tracking to unlock"))
        .alert(achievement.title, isPresented: $showDetail) {
            Button(String(localized: "OK"), role: .cancel) {}
        } message: {
            if let date = achievement.unlockedAt {
                Text("\(achievement.descriptionText)\n\n\(String(localized: "Unlocked:"))\n\(date.formatted(date: .abbreviated, time: .omitted))")
            }
        }
    }
}
```

**Step 2: Build and verify**

```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
```

**Step 3: Commit**

```bash
git add Fluidic/Components/AchievementBadgeView.swift
git commit -m "feat: add AchievementBadgeView component with lock/unlock states"
```

---

### Task 9: Create AchievementToastView component

**Files:**
- Create: `Fluidic/Components/AchievementToastView.swift`

**Step 1: Create the toast**

Create `Fluidic/Components/AchievementToastView.swift`:
```swift
import SwiftUI

struct AchievementToastView: View {
    let achievement: Achievement
    let onDismiss: () -> Void

    @State private var isVisible = false

    var body: some View {
        VStack {
            Spacer()

            if isVisible {
                HStack(spacing: 12) {
                    Image(systemName: achievement.iconName)
                        .font(.title2)
                        .foregroundStyle(FluidicTheme.waterBlue)

                    VStack(alignment: .leading, spacing: 2) {
                        Text(String(localized: "Achievement Unlocked!"))
                            .font(.caption)
                            .fontWeight(.semibold)
                            .foregroundStyle(FluidicTheme.textSecondary)

                        Text(achievement.title)
                            .font(.subheadline)
                            .fontWeight(.bold)
                            .foregroundStyle(FluidicTheme.textPrimary)
                    }

                    Spacer()
                }
                .padding()
                .background(FluidicTheme.cardBackground)
                .clipShape(RoundedRectangle(cornerRadius: 16))
                .shadow(color: FluidicTheme.cardShadow, radius: 8, y: 4)
                .padding(.horizontal)
                .padding(.bottom, 32)
                .transition(.move(edge: .bottom).combined(with: .opacity))
            }
        }
        .onAppear {
            withAnimation(.spring(response: 0.5, dampingFraction: 0.8)) {
                isVisible = true
            }
            DispatchQueue.main.asyncAfter(deadline: .now() + 3.0) {
                withAnimation(.easeOut(duration: 0.3)) {
                    isVisible = false
                }
                DispatchQueue.main.asyncAfter(deadline: .now() + 0.4) {
                    onDismiss()
                }
            }
        }
        .accessibilityLabel(String(localized: "Achievement unlocked: \(achievement.title)"))
    }
}
```

**Step 2: Build and verify**

```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
```

**Step 3: Commit**

```bash
git add Fluidic/Components/AchievementToastView.swift
git commit -m "feat: add AchievementToastView for in-app unlock notifications"
```

---

### Task 10: Add achievements section to HistoryView

**Files:**
- Modify: `Fluidic/Views/HistoryView.swift:4-6` (add achievementManager access)
- Modify: `Fluidic/Views/HistoryView.swift:132-133` (add achievements grid before calendar)

**Step 1: Add achievements grid to HistoryView**

In `Fluidic/Views/HistoryView.swift`, add a state property for achievements after the existing properties (around line 6):
```swift
@State private var achievements: [Achievement] = []
```

In the body, after the bar chart section and before the MonthCalendarView (around line 132), add:
```swift
// MARK: - Achievements
VStack(alignment: .leading, spacing: 12) {
    Text(String(localized: "Achievements"))
        .font(.headline)
        .foregroundStyle(FluidicTheme.textPrimary)

    let unlockedCount = achievements.filter(\.isUnlocked).count
    Text(String(localized: "\(unlockedCount) of \(achievements.count) unlocked"))
        .font(.caption)
        .foregroundStyle(FluidicTheme.textSecondary)

    LazyVGrid(columns: Array(repeating: GridItem(.flexible(), spacing: 8), count: 5), spacing: 12) {
        ForEach(achievements, id: \.achievementId) { achievement in
            AchievementBadgeView(achievement: achievement)
        }
    }
}
.padding()
.background(FluidicTheme.cardBackground)
.clipShape(RoundedRectangle(cornerRadius: 16))
.shadow(color: FluidicTheme.cardShadow, radius: 4, y: 2)
```

Add an `.onAppear` modifier to the ScrollView to load achievements:
```swift
.onAppear {
    achievements = viewModel.achievementManager.allAchievements()
}
```

**Step 2: Build and verify**

```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
```

**Step 3: Commit**

```bash
git add Fluidic/Views/HistoryView.swift
git commit -m "feat: add achievements badge grid to HistoryView"
```

---

### Task 11: Add achievement toast to HomeView

**Files:**
- Modify: `Fluidic/Views/HomeView.swift:90-94` (add toast overlay alongside celebration)

**Step 1: Add toast overlay**

In `Fluidic/Views/HomeView.swift`, after the CelebrationView overlay (around line 90-94), add another overlay:
```swift
.overlay {
    if let achievement = viewModel.achievementManager.newlyUnlocked {
        AchievementToastView(achievement: achievement) {
            viewModel.achievementManager.dismissToast()
        }
    }
}
```

**Step 2: Build and verify**

```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
```

**Step 3: Commit**

```bash
git add Fluidic/Views/HomeView.swift
git commit -m "feat: show achievement unlock toast on HomeView"
```

---

### Task 12: Add hasCompletedOnboarding to UserSettings

**Files:**
- Modify: `Fluidic/Models/UserSettings.swift:6-13` (add property)
- Modify: `Fluidic/Models/UserSettings.swift:15-33` (add to initializer)

**Step 1: Add property**

In `Fluidic/Models/UserSettings.swift`, add after the existing properties (around line 13):
```swift
var hasCompletedOnboarding: Bool
```

**Step 2: Add to initializer**

In the initializer, add the parameter with default `false` and assign it:
```swift
hasCompletedOnboarding: Bool = false
```
And in the body:
```swift
self.hasCompletedOnboarding = hasCompletedOnboarding
```

**Step 3: Build and verify**

```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
```

**Step 4: Commit**

```bash
git add Fluidic/Models/UserSettings.swift
git commit -m "feat: add hasCompletedOnboarding flag to UserSettings"
```

---

### Task 13: Create OnboardingView

**Files:**
- Create: `Fluidic/Views/OnboardingView.swift`

**Step 1: Create the full onboarding flow**

Create `Fluidic/Views/OnboardingView.swift`:
```swift
import SwiftUI

struct OnboardingView: View {
    @Bindable var viewModel: WaterViewModel
    let onComplete: () -> Void

    @State private var currentPage = 0
    @State private var selectedGoal: Double = 2500
    @State private var selectedCupSize: Double = 250
    @State private var enableNotifications = true

    private let goalPresets: [Double] = [2000, 2500, 3000]
    private let cupSizes: [Double] = [100, 150, 200, 250, 330, 500]

    var body: some View {
        ZStack {
            FluidicTheme.backgroundGradient
                .ignoresSafeArea()

            VStack(spacing: 0) {
                // Progress dots
                HStack(spacing: 8) {
                    ForEach(0..<4, id: \.self) { index in
                        Circle()
                            .fill(index == currentPage ? FluidicTheme.waterBlue : FluidicTheme.textSecondary.opacity(0.3))
                            .frame(width: 8, height: 8)
                    }
                }
                .padding(.top, 20)

                TabView(selection: $currentPage) {
                    welcomePage.tag(0)
                    goalPage.tag(1)
                    cupSizePage.tag(2)
                    notificationsPage.tag(3)
                }
                .tabViewStyle(.page(indexDisplayMode: .never))
                .animation(.easeInOut(duration: 0.3), value: currentPage)
            }
        }
    }

    // MARK: - Welcome

    private var welcomePage: some View {
        VStack(spacing: 24) {
            Spacer()

            Image(systemName: "drop.fill")
                .font(.system(size: 80))
                .foregroundStyle(FluidicTheme.waterGradient)

            Text(String(localized: "Welcome to Fluidic"))
                .font(.largeTitle)
                .fontWeight(.bold)
                .foregroundStyle(FluidicTheme.textPrimary)

            Text(String(localized: "Track your hydration, build healthy habits"))
                .font(.body)
                .foregroundStyle(FluidicTheme.textSecondary)
                .multilineTextAlignment(.center)
                .padding(.horizontal, 40)

            Spacer()

            continueButton { currentPage = 1 }
                .padding(.bottom, 40)
        }
    }

    // MARK: - Goal

    private var goalPage: some View {
        VStack(spacing: 24) {
            Spacer()

            Image(systemName: "flag.fill")
                .font(.system(size: 60))
                .foregroundStyle(FluidicTheme.waterBlue)

            Text(String(localized: "Set Your Daily Goal"))
                .font(.title)
                .fontWeight(.bold)
                .foregroundStyle(FluidicTheme.textPrimary)

            Text(String(localized: "\(Int(selectedGoal)) ml"))
                .font(.system(size: 48, weight: .bold, design: .rounded))
                .foregroundStyle(FluidicTheme.waterBlue)
                .contentTransition(.numericText())

            Slider(value: $selectedGoal, in: 500...5000, step: 250)
                .tint(FluidicTheme.waterBlue)
                .padding(.horizontal, 40)

            HStack(spacing: 12) {
                ForEach(goalPresets, id: \.self) { preset in
                    Button {
                        withAnimation { selectedGoal = preset }
                    } label: {
                        Text("\(Int(preset))")
                            .font(.subheadline)
                            .fontWeight(.medium)
                            .padding(.horizontal, 16)
                            .padding(.vertical, 8)
                            .background(selectedGoal == preset ? FluidicTheme.waterBlue : FluidicTheme.cardBackground)
                            .foregroundStyle(selectedGoal == preset ? .white : FluidicTheme.textPrimary)
                            .clipShape(Capsule())
                    }
                }
            }

            Spacer()

            skipAndContinue { currentPage = 2 }
                .padding(.bottom, 40)
        }
    }

    // MARK: - Cup Size

    private var cupSizePage: some View {
        VStack(spacing: 24) {
            Spacer()

            Image(systemName: "cup.and.saucer.fill")
                .font(.system(size: 60))
                .foregroundStyle(FluidicTheme.waterBlue)

            Text(String(localized: "Choose Your Cup Size"))
                .font(.title)
                .fontWeight(.bold)
                .foregroundStyle(FluidicTheme.textPrimary)

            LazyVGrid(columns: Array(repeating: GridItem(.flexible(), spacing: 12), count: 3), spacing: 12) {
                ForEach(cupSizes, id: \.self) { size in
                    Button {
                        withAnimation { selectedCupSize = size }
                    } label: {
                        VStack(spacing: 4) {
                            Image(systemName: "drop.fill")
                                .font(.title3)
                                .scaleEffect(size / 250.0 * 0.8 + 0.4)
                            Text("\(Int(size)) ml")
                                .font(.subheadline)
                                .fontWeight(.medium)
                        }
                        .frame(maxWidth: .infinity)
                        .padding(.vertical, 16)
                        .background(selectedCupSize == size ? FluidicTheme.waterBlue : FluidicTheme.cardBackground)
                        .foregroundStyle(selectedCupSize == size ? .white : FluidicTheme.textPrimary)
                        .clipShape(RoundedRectangle(cornerRadius: 12))
                    }
                }
            }
            .padding(.horizontal, 24)

            Spacer()

            skipAndContinue { currentPage = 3 }
                .padding(.bottom, 40)
        }
    }

    // MARK: - Notifications

    private var notificationsPage: some View {
        VStack(spacing: 24) {
            Spacer()

            Image(systemName: "bell.badge.fill")
                .font(.system(size: 60))
                .foregroundStyle(FluidicTheme.waterBlue)

            Text(String(localized: "Stay on Track"))
                .font(.title)
                .fontWeight(.bold)
                .foregroundStyle(FluidicTheme.textPrimary)

            Text(String(localized: "Get reminders to drink water throughout the day"))
                .font(.body)
                .foregroundStyle(FluidicTheme.textSecondary)
                .multilineTextAlignment(.center)
                .padding(.horizontal, 40)

            Toggle(String(localized: "Enable Reminders"), isOn: $enableNotifications)
                .padding(.horizontal, 40)
                .tint(FluidicTheme.waterBlue)

            Spacer()

            VStack(spacing: 12) {
                Button {
                    completeOnboarding()
                } label: {
                    Text(String(localized: "Get Started"))
                        .font(.headline)
                        .foregroundStyle(.white)
                        .frame(maxWidth: .infinity)
                        .padding(.vertical, 16)
                        .background(FluidicTheme.waterBlue)
                        .clipShape(RoundedRectangle(cornerRadius: 16))
                }
                .padding(.horizontal, 40)

                Button {
                    enableNotifications = false
                    completeOnboarding()
                } label: {
                    Text(String(localized: "Skip"))
                        .font(.subheadline)
                        .foregroundStyle(FluidicTheme.textSecondary)
                }
            }
            .padding(.bottom, 40)
        }
    }

    // MARK: - Helpers

    private func completeOnboarding() {
        viewModel.settings?.dailyGoalML = selectedGoal
        viewModel.settings?.cupSizeML = selectedCupSize
        viewModel.settings?.notificationsEnabled = enableNotifications
        viewModel.settings?.hasCompletedOnboarding = true
        viewModel.saveChanges()

        if enableNotifications {
            Task {
                await viewModel.setupNotifications()
                await viewModel.scheduleReminders()
            }
        }

        onComplete()
    }

    private func continueButton(action: @escaping () -> Void) -> some View {
        Button(action: action) {
            Text(String(localized: "Continue"))
                .font(.headline)
                .foregroundStyle(.white)
                .frame(maxWidth: .infinity)
                .padding(.vertical, 16)
                .background(FluidicTheme.waterBlue)
                .clipShape(RoundedRectangle(cornerRadius: 16))
        }
        .padding(.horizontal, 40)
    }

    private func skipAndContinue(action: @escaping () -> Void) -> some View {
        VStack(spacing: 12) {
            continueButton(action: action)

            Button(action: action) {
                Text(String(localized: "Skip"))
                    .font(.subheadline)
                    .foregroundStyle(FluidicTheme.textSecondary)
            }
        }
    }
}
```

**Step 2: Build and verify**

```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
```

**Step 3: Commit**

```bash
git add Fluidic/Views/OnboardingView.swift
git commit -m "feat: add 4-screen onboarding flow with goal, cup size, and notifications"
```

---

### Task 14: Wire onboarding into ContentView

**Files:**
- Modify: `Fluidic/ContentView.swift` (add onboarding conditional)

**Step 1: Add showOnboarding state**

In `Fluidic/ContentView.swift`, add a state property:
```swift
@State private var showOnboarding = false
```

**Step 2: Wrap body with onboarding check**

In the main body, wrap the existing TabView content with a conditional. If `showOnboarding` is true, show OnboardingView instead of the TabView. The check happens after viewModel is loaded:

After the viewModel is set up in `onAppear`, add:
```swift
showOnboarding = !(vm.settings?.hasCompletedOnboarding ?? false)
```

Then in the body, wrap the TabView with:
```swift
if showOnboarding, let viewModel {
    OnboardingView(viewModel: viewModel) {
        withAnimation {
            showOnboarding = false
        }
    }
} else {
    // existing TabView code
}
```

**Step 3: Build and verify**

```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
```

**Step 4: Commit**

```bash
git add Fluidic/ContentView.swift
git commit -m "feat: wire onboarding into ContentView as conditional root"
```

---

### Task 15: Add empty states for History and Achievements

**Files:**
- Modify: `Fluidic/Views/HistoryView.swift` (empty state for chart and achievements)

**Step 1: Add empty state for weekly chart**

In `Fluidic/Views/HistoryView.swift`, inside the bar chart section, add a conditional check. If all weekData values are 0, show an empty state instead of the chart:
```swift
if weekData.allSatisfy({ $0.total == 0 }) {
    VStack(spacing: 8) {
        Image(systemName: "chart.bar")
            .font(.title)
            .foregroundStyle(FluidicTheme.textSecondary.opacity(0.5))
        Text(String(localized: "No data for this week"))
            .font(.subheadline)
            .foregroundStyle(FluidicTheme.textSecondary)
        Text(String(localized: "Start logging water to see your progress"))
            .font(.caption)
            .foregroundStyle(FluidicTheme.textSecondary.opacity(0.7))
    }
    .frame(height: 180)
    .frame(maxWidth: .infinity)
} else {
    // existing Chart code
}
```

**Step 2: Build and verify**

```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
```

**Step 3: Commit**

```bash
git add Fluidic/Views/HistoryView.swift
git commit -m "feat: add empty states for history chart when no data exists"
```

---

### Task 16: Add accessibility labels throughout

**Files:**
- Modify: `Fluidic/Components/WaterCupView.swift` (accessibility)
- Modify: `Fluidic/Components/QuickAddButton.swift` (accessibility)
- Modify: `Fluidic/Components/ProgressRingView.swift` (accessibility)
- Modify: `Fluidic/Views/HomeView.swift` (accessibility)

**Step 1: Add accessibility to WaterCupView**

In `Fluidic/Components/WaterCupView.swift`, add after the tap gesture modifier:
```swift
.accessibilityLabel(String(localized: "Water cup"))
.accessibilityValue(String(localized: "\(Int(progress * 100)) percent of daily goal"))
.accessibilityHint(String(localized: "Double tap to add water"))
.accessibilityAddTraits(.isButton)
```

**Step 2: Add accessibility to QuickAddButton**

In `Fluidic/Components/QuickAddButton.swift`, add to the Button:
```swift
.accessibilityLabel(String(localized: "Add \(amount) milliliters"))
```

**Step 3: Add accessibility to ProgressRingView**

In `Fluidic/Components/ProgressRingView.swift`, add:
```swift
.accessibilityLabel(String(localized: "Progress"))
.accessibilityValue(String(localized: "\(Int(progress * 100)) percent"))
```

**Step 4: Build and verify**

```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
```

**Step 5: Commit**

```bash
git add Fluidic/Components/WaterCupView.swift Fluidic/Components/QuickAddButton.swift Fluidic/Components/ProgressRingView.swift
git commit -m "feat: add VoiceOver accessibility labels to all interactive components"
```

---

### Task 17: Add localization strings for new features (EN + CS)

**Files:**
- Modify: `Fluidic/Localizable.xcstrings` (add new translation keys)

**Step 1: Add all new localization keys**

Open `Fluidic/Localizable.xcstrings` and add entries for:

**Onboarding:**
- "Welcome to Fluidic" / "Vítejte ve Fluidic"
- "Track your hydration, build healthy habits" / "Sledujte svou hydrataci, budujte zdravé návyky"
- "Set Your Daily Goal" / "Nastavte svůj denní cíl"
- "Choose Your Cup Size" / "Vyberte velikost sklenice"
- "Stay on Track" / "Zůstaňte na správné cestě"
- "Get reminders to drink water throughout the day" / "Dostávejte připomínky k pití vody během dne"
- "Enable Reminders" / "Povolit připomínky"
- "Get Started" / "Začít"
- "Continue" / "Pokračovat"
- "Skip" / "Přeskočit"

**Achievements:**
- "Achievements" / "Úspěchy"
- "Achievement Unlocked!" / "Úspěch odemčen!"
- "Locked achievement" / "Zamčený úspěch"
- "Keep tracking to unlock" / "Pokračujte ve sledování pro odemčení"
- "Unlocked:" / "Odemčeno:"
- "%lld of %lld unlocked" / "%lld z %lld odemčeno"

**Empty States:**
- "No data for this week" / "Žádná data za tento týden"
- "Start logging water to see your progress" / "Začněte zaznamenávat vodu pro zobrazení pokroku"

Note: The Localizable.xcstrings is JSON format. Each key gets an entry under `"strings"` with `"localizations"` containing `"cs"` and `"en"` `"stringUnit"` entries. Follow the existing format in the file.

**Step 2: Build and verify**

```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
```

**Step 3: Commit**

```bash
git add Fluidic/Localizable.xcstrings
git commit -m "feat: add EN + CS localization for onboarding, achievements, and empty states"
```

---

### Task 18: Final build verification and cleanup

**Files:**
- All files (build check)

**Step 1: Full clean build**

```bash
xcodebuild -project Fluidic.xcodeproj -scheme Fluidic -destination 'platform=iOS Simulator,name=iPhone 16' clean build 2>&1 | tail -20
```

Expected: BUILD SUCCEEDED with no warnings.

**Step 2: Check for any SwiftUI preview issues**

Scan for any missing imports or broken previews:
```bash
grep -rn "Preview" Fluidic/Views/ Fluidic/Components/
```

**Step 3: Verify version consistency**

```bash
grep -n "MARKETING_VERSION" Fluidic.xcodeproj/project.pbxproj
```

All entries should show `0.0.1`.

**Step 4: Final commit if any cleanup was needed**

```bash
git add -A && git commit -m "chore: final v0.0.1 cleanup and build verification"
```

---

## Summary

| Task | Description | Files |
|------|-------------|-------|
| 1 | Fix version + clean HealthKit refs | project.pbxproj |
| 2 | Notification reliability on foreground | ContentView, WaterViewModel |
| 3 | Explicit saves after mutations | WaterViewModel |
| 4 | Smooth wave dampening | WaterCupView |
| 5 | Achievement SwiftData model | Achievement.swift, FluidicApp |
| 6 | AchievementManager service | AchievementManager.swift |
| 7 | Integrate achievements into ViewModel | WaterViewModel, ContentView |
| 8 | AchievementBadgeView component | AchievementBadgeView.swift |
| 9 | AchievementToastView component | AchievementToastView.swift |
| 10 | Achievements in HistoryView | HistoryView |
| 11 | Achievement toast in HomeView | HomeView |
| 12 | hasCompletedOnboarding flag | UserSettings |
| 13 | OnboardingView (4 screens) | OnboardingView.swift |
| 14 | Wire onboarding into ContentView | ContentView |
| 15 | Empty states for History | HistoryView |
| 16 | Accessibility labels | WaterCupView, QuickAddButton, ProgressRingView |
| 17 | Localization (EN + CS) | Localizable.xcstrings |
| 18 | Final build verification | All |
